<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- Подключение Font Awesome -->
    <style>
        /* Стили для улучшенной таблицы */
        .table-custom {
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }
        .table-custom th, .table-custom td {
            border: 1px solid #007bff; /* Цвет рамки ячеек */
        }
        .table-custom th {
            background-color: #007bff; /* Цвет фона заголовка */
            color: white; /* Цвет текста заголовка */
        }
        .table-custom td {
            background-color: white; /* Цвет фона ячеек с данными */
            color: black; /* Цвет текста в ячейках с данными */
        }
        .table-custom tr td:first-child {
            background-color: white; /* Фон для первого столбца (Спорт) */
            color: black; /* Цвет текста для первого столбца */
        }
        .table-custom tr th {
            background-color: #007bff; /* Цвет фона заголовка */
            color: white; /* Цвет текста заголовка */
        }
        .btn-custom {
            background-color: #28a745;
            color: white;
        }
        .btn-custom:hover {
            background-color: #218838;
            color: white;
        }
        .delete-btn {
            cursor: pointer; /* Указатель при наведении */
            color: red; /* Цвет иконки */
            font-size: 1.75rem; /* Увеличенный размер иконки */
            width: 100%; /* Ширина ячейки */
            height: 100%; /* Высота ячейки */
            text-align: center; /* Центрирование текста */
            display: flex; /* Flexbox для центрирования */
            align-items: center; /* Вертикальное центрирование */
            justify-content: center; /* Горизонтальное центрирование */
        }
        .delete-btn:hover {
            color: darkred; /* Изменение цвета при наведении */
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h1>Live-вилки</h1>
        <a href="/subscriptions/account" class="btn btn-primary">Личный кабинет</a>
    </div>
    <div class="card shadow-lg">
        <div class="card-body">
            <button id="stopButton" class="btn btn-custom mb-3">
                <span th:text='${sendingData ? "Остановить обновление" : "Продолжить обновление"}'></span>
            </button>
            <button id="deleteAllButton" class="btn btn-danger mb-3">Удалить все</button>
            <table class="table table-custom table-hover">
                <thead>
                <tr>
                    <th scope="col" class="text-center">Событие</th>
                    <th scope="col" class="text-center">Контора</th>
                    <th scope="col" class="text-center">Коэф</th>
                    <th scope="col" class="text-center">Ставка</th>
                    <th scope="col" class="text-center">Удалить</th>
                </tr>
                </thead>
                <tbody id="bettingTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;

    // Загружаем состояние isUpdating из localStorage или устанавливаем по умолчанию
    let isUpdating = JSON.parse(sessionStorage.getItem('isUpdating')) || false;
    let hiddenEvents = JSON.parse(localStorage.getItem('hiddenEvents')) || []; // Скрытые события пользователя


    // Обновляем текст кнопки в зависимости от состояния
    function updateButtonText() {
        const button = document.getElementById('stopButton');
        button.querySelector('span').innerText = isUpdating ? "Остановить обновление" : "Продолжить обновление";
    }

    // Функция для подключения к WebSocket
    function connect() {
        const socket = new SockJS('/ws'); // Замените '/ws' на ваш путь
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/bets', function (message) {
                const bet = JSON.parse(message.body);
                if (isUpdating && !isEventHidden(bet.event)) { // Проверяем, скрыто ли событие
                    addBetToTable(bet);
                    saveBetToLocalStorage(bet);
                }
            });
        });
    }

    function isEventHidden(eventName) {
        return hiddenEvents.includes(eventName);
    }

    // Функция для добавления ставки в таблицу
    function addBetToTable(bet) {
        const tableBody = document.getElementById('bettingTableBody');
        let existingRow = null;

        // Проверяем, есть ли уже строка с таким событием
        for (const row of tableBody.rows) {
            if (row.cells[0].innerText === bet.event) { // Сравнение по полю event
                existingRow = row;
                break;
            }
        }

        if (existingRow) {
            // Обновляем данные существующей строки
            existingRow.cells[1].innerText = bet.bookmaker;
            existingRow.cells[2].innerText = bet.ratio;
            existingRow.cells[3].innerText = bet.bet;
        } else {
            // Если не найдена строка с таким событием, добавляем новую
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
            <td class="text-center">${bet.event}</td>
            <td class="text-center">${bet.bookmaker}</td>
            <td class="text-center">${bet.ratio}</td>
            <td class="text-center">${bet.bet}</td>
            <td class="text-center"><i class="fas fa-trash delete-btn" onclick="deleteBet(this, '${bet.event}')"></i></td>
        `;

            tableBody.prepend(newRow); // Добавляем новую строку в начало таблицы
        }
    }


    // Функция для удаления ставки из таблицы
    function deleteBet(element, eventName) {
        const row = element.closest('tr'); // Находим родительскую строку
        row.remove(); // Удаляем строку

        if (!hiddenEvents.includes(eventName)) {
            hiddenEvents.push(eventName);
            localStorage.setItem('hiddenEvents', JSON.stringify(hiddenEvents));
        }
    }

    function deleteAllBets() {
        const tableBody = document.getElementById('bettingTableBody');
        tableBody.innerHTML = ''; // Очистка таблицы
        localStorage.removeItem('bets'); // Очистка localStorage
    }

    // Функция для сохранения ставки в localStorage
    function saveBetToLocalStorage(bet) {
        let bets = JSON.parse(localStorage.getItem('bets')) || [];

        // Найти индекс существующей ставки с таким же событием
        const existingIndex = bets.findIndex(item => item.event === bet.event);

        if (existingIndex !== -1) {
            // Обновить существующую ставку
            bets[existingIndex] = bet;
        } else {
            // Добавить новую ставку в начало массива
            bets.unshift(bet);
        }

        localStorage.setItem('bets', JSON.stringify(bets));
    }


    // Функция для загрузки ставок из localStorage
    function loadBetsFromLocalStorage() {
        const storedBets = JSON.parse(localStorage.getItem('bets'));
        if (storedBets) {
            // Обратный порядок добавления, чтобы последние элементы шли первыми
            storedBets.reverse().forEach(bet => {
                addBetToTable(bet); // Добавляем каждую ставку в таблицу
            });
        }
    }

    // Запускаем соединение
    connect();
    loadBetsFromLocalStorage(); // Загружаем ставки из localStorage при загрузке страницы
    updateButtonText(); // Устанавливаем текст кнопки при загрузке

    // Обработчик для кнопки остановки обновления
    document.getElementById('stopButton').addEventListener('click', () => {
        isUpdating = !isUpdating; // Меняем флаг на противоположный
        sessionStorage.setItem('isUpdating', JSON.stringify(isUpdating)); // Сохраняем состояние
        if (isUpdating) {
            stompClient.send('/app/startUpdates'); // Отправляем команду на сервер для продолжения обновления
        } else {
            stompClient.send('/app/stopUpdates'); // Отправляем команду на сервер для остановки обновления
        }
        updateButtonText(); // Обновляем текст кнопки
    });

    document.getElementById('deleteAllButton').addEventListener('click', deleteAllBets);
</script>
</body>
</html>
